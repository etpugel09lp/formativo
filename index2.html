<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF--8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IA On-Device: Generador de Sesiones v6.0 (Carga Dinámica)</title>
  <style>
    /* Estilos (sin cambios) */
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f8f9fa; margin: 0; padding: 20px; display: flex; justify-content: center; }
    .container { max-width: 800px; width: 100%; background: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    h1 { color: #00695c; text-align: center; margin-bottom: 5px; }
    .subtitle { text-align: center; color: #5f6368; margin-top: 0; margin-bottom: 25px;}
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #3c4043; }
    input[type="text"] { width: 100%; padding: 12px; border: 1px solid #dfe1e5; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    input[type="text"]:focus { border-color: #00897b; outline: none; box-shadow: 0 0 0 3px rgba(0, 137, 123, 0.2); }
    button { width: 100%; padding: 14px; background-color: #00897b; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; transition: background-color 0.2s; }
    button:disabled { background-color: #9E9E9E; cursor: not-allowed; }
    button:hover:enabled { background-color: #00695c; }
    
    #status { margin-top: 30px; text-align: center; font-weight: bold; color: #00695c; padding: 15px; background-color: #e0f2f1; border-radius: 8px; display: none; }
    #result-container { margin-top: 20px; padding: 20px; border: 1px solid #dfe1e5; border-radius: 8px; background-color: #fdfdff; min-height: 150px; line-height: 1.6; white-space: pre-wrap; }
  </style>
</head>
<body>

  <div class="container">
    <h1>Generador de Sesiones de Aprendizaje</h1>
    <p class="subtitle">IA 100% Local (Modelo Qwen2 Estable)</p>

    <form id="sessionForm">
      <div class="form-group">
        <label for="topic">Tema de la Sesión:</label>
        <input type="text" id="topic" value="LA TORTA HELADA" required>
      </div>
      <div class="form-group">
        <label for="grade">Nivel Educativo / Audiencia:</label>
        <input type="text" id="grade" value="Estudiantes de Educación Técnico-Productiva (ETP) en Pastelería" required>
      </div>
      <button type="submit" id="submitButton">Generar Sesión</button>
    </form>
    
    <div id="status"></div>
    
    <div id="result-container">
      <p style="color: #5f6368;">Aquí aparecerá tu plan de sesión de aprendizaje...</p>
    </div>
  </div>

  <script type="module">
    // --- NO HAY IMPORTACIÓN AQUÍ ---
    // La página carga instantáneamente porque no se bloquea por la librería de IA.

    const form = document.getElementById('sessionForm');
    const submitButton = document.getElementById('submitButton');
    const statusDiv = document.getElementById('status');
    const resultContainer = document.getElementById('result-container');

    // Usamos una clase "Singleton" para gestionar la IA.
    // Esto asegura que la librería y el modelo se carguen solo una vez.
    class AI_Singleton {
        static instance = null;
        static tokenizer = null;
        static model = null;

        static async getInstance(progress_callback = null) {
            if (this.instance === null) {
                statusDiv.innerText = 'Inicializando módulo de IA (solo la primera vez)...';
                
                // --- CAMBIO CLAVE: Importación Dinámica ---
                // La librería solo se descarga y procesa CUANDO se llama a esta función.
                const { pipeline, env } = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.0');
                
                env.allowLocalModels = false;
                env.useBrowserCache = true;
                
                statusDiv.innerText = 'Cargando modelo de IA estable (Qwen2)...';
                this.instance = await pipeline('text-generation', 'Xenova/Qwen2-0.5B-Instruct-q4', { progress_callback });
            }
            return this.instance;
        }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const topic = document.getElementById('topic').value;
      const grade = document.getElementById('grade').value;

      submitButton.disabled = true;
      submitButton.innerText = 'Procesando...';
      resultContainer.innerHTML = '';
      statusDiv.style.display = 'block';
      
      try {
        // Obtenemos la instancia de la IA. La primera vez, esto hará todo el trabajo pesado.
        // Las veces siguientes, devolverá instantáneamente el generador ya cargado.
        const generator = await AI_Singleton.getInstance((progress) => {
            statusDiv.innerText = `Cargando modelo... ${progress.file} (${Math.round(progress.progress)}%)`;
        });

        statusDiv.innerText = 'El modelo Qwen2 está generando tu plan...';

        const messages = [
            { role: "system", content: "Eres un experto diseñador instruccional que crea planes de sesión de aprendizaje en español. Tu respuesta debe ser clara, útil y estar bien estructurada." },
            { role: "user", content: `Crea un plan de sesión de aprendizaje detallado para el tema "${topic}", dirigido a la audiencia: "${grade}".\n\nGenera 5 secciones:\n1. Objetivo de Aprendizaje\n2. Actividades de Inicio\n3. Desarrollo de la Lección\n4. Actividad de Cierre\n5. Materiales Necesarios` }
        ];

        const prompt = generator.tokenizer.apply_chat_template(messages, { tokenize: false, add_generation_prompt: true });

        const output = await generator(prompt, { max_new_tokens: 512 });
        
        const generatedText = output[0].generated_text;
        
        // Limpiamos el texto de tokens especiales antes de mostrarlo
        const cleanText = generatedText.replace(/<\|im_start\|>assistant\n/, '').replace(/<\|im_end\|>/, '');
        resultContainer.innerText = cleanText.trim();
        statusDiv.style.display = 'none';

      } catch (error) {
        statusDiv.style.display = 'none';
        resultContainer.innerHTML = `<p style="color:red;"><strong>Ha ocurrido un error:</strong> ${error.message}</p><p style="color:gray;">Por favor, intenta limpiar la caché de tu navegador y recarga la página.</p>`;
        console.error(error);
      } finally {
        submitButton.disabled = false;
        submitButton.innerText = 'Generar Sesión';
      }
    });
  </script>

</body>
</html>
